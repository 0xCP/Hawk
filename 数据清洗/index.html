<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>7.数据清洗 - Hawk doc</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "7.\u6570\u636e\u6e05\u6d17";
    var mkdocs_page_input_path = "\u6570\u636e\u6e05\u6d17.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Hawk doc</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">1.Hawk</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../快速教程/">2.快速教程</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Hawk工程/">3.Hawk工程</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../主要组件介绍/">4.主要组件介绍</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../数据表和数据库连接/">5.数据表和数据库连接</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../网页采集器/">6.网页采集器</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">7.数据清洗</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#_1">数据清洗</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#1">1.参数说明</a></li>
        
            <li><a class="toctree-l3" href="#2">2.几种模块的介绍</a></li>
        
            <li><a class="toctree-l3" href="#3">3.超级拷贝</a></li>
        
            <li><a class="toctree-l3" href="#4">4.线程管理</a></li>
        
            <li><a class="toctree-l3" href="#5">5.运行模式</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../转换器/">8.转换器</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../常用/">9.常用</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../过滤器/">10.过滤器</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../执行器/">11.执行器</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../生成器/">12.生成器</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../子任务引擎/">13.子任务引擎</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../动态页面抓取专题/">14.动态页面抓取专题</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../命令行增量和自动化专题/">15.命令行增量和自动化专题</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../编译和扩展开发/">16.编译和扩展开发</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../常见问题/">17.常见问题</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../更新日志和作者/">18.更新日志和作者</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../设计Hawk背后的故事(2016)/">19.设计Hawk背后的故事(2016)</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../花一年时间,给爬虫Hawk再讲个故事(2018)/">20.花一年时间,给爬虫Hawk再讲个故事(2018)</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Hawk doc</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>7.数据清洗</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="_1">数据清洗</h1>
<p>数据清洗是一种任务，包括几十个子模块， 这些子模块包含四类：生成， 转换， 过滤和执行。</p>
<p><img alt="丰富的模块" src="https://images2018.cnblogs.com/blog/287060/201805/287060-20180506160120254-60486829.png" /></p>
<p>数据清洗可以通过组合多个不同的子模块，生成多样的功能，通过拖拽构造出一个工作流，它能够产生一个有限或无限的文档序列。比如下面：</p>
<p><img alt="image_1auq4oooc1m8m9tc02sjv1j4o9.png-71.6kB" src="http://static.zybuluo.com/buptzym/gzr3u0z80478s31u9v1zdfw5/image_1auq4oooc1m8m9tc02sjv1j4o9.png" /></p>
<h2 id="1">1.参数说明</h2>
<h3 id="11">1.1.工作模式</h3>
<ul>
<li>多文档 :生成多条数据（文档）</li>
<li>单文档 :  单文档</li>
<li>不进行转换: 按照原始数据返回</li>
</ul>
<h2 id="2">2.几种模块的介绍</h2>
<h3 id="21">2.1.转换器</h3>
<p>转换器是最为常用的一种类型，当然它的使用也是最复杂的。</p>
<p>转换器有三种子类型：</p>
<ul>
<li>ColumnUDF: 单文档： 只对一个列有效，如<code>提取数字</code>,</li>
<li>UDF: 单文档：如删除该列，它仅涉及文档内部的修改，可能会影响多个列</li>
<li>UDAF: 多文档：典型的如 多文档模式下从爬虫转换，每一行url都可能生成20个甚至更多的文档，它的行为cross(交叉)模式下的生成器。</li>
</ul>
<p>ColumnUDF是UDF的特例， UDF是UDAF的特例（只产生一种）
绝大多数转换器都是UDF类型。但同一个转换器在不同的配置下，可能会有多种行为，例如<code>从爬虫转换</code>，如果选择的 网页采集器 为单文档(单文档)模式，则该转换器为UDF模式，若为 多文档模式，则为UDAF模式。</p>
<ul>
<li>输入列: 就是要输入这个模块的列，（Hawk1时代也称作原列名）;</li>
<li>输出列: 则指的是模块输出的列。 UDF模式下，如果新列名为空，则新列名等于原列名，直接修改在原始列上。</li>
</ul>
<h3 id="22udaf">2.2.关于UDAF的必要说明</h3>
<p>当你使用多文档模式的爬虫，或单转多时，虽然生成了多个文档，但原始的数据（如URL）不见了。这是因为Hawk丢弃了这些列。</p>
<p>经过大量实践，如果不这么做，每个新数据后面，都会跟上原始的老数据，如果1转20，则老数据会重复生成20次，这是没有必要的。有时不得不拖入大量的<code>删除该列</code>来处理。
当然，有时转换时需要包含原始数据的部分列，则可在转换器的<code>新列名</code>中填写要<code>鲤鱼跳龙门</code>的列的名称，中间用空格分割。</p>
<ul>
<li>在Hawk3中，还支持在新列名中输入<code>*</code>号，此时所有的原始列都会添到新的文档之中。</li>
<li>注意，UDAF的新列可能会覆盖掉原始列的数据，因此多检查列名，避免意料之外的覆盖</li>
</ul>
<h3 id="23">2.3.过滤器</h3>
<p>过滤器可以在流中，过滤掉不符合条件的文档（也就是横向过滤）。</p>
<ul>
<li>可勾选<code>反向</code>，此时只会留下不符合条件的文档。即对原始结果做了取反。</li>
<li>如何对列过滤？ 目前Hawk并未提供该功能，可通过拖入多个删除该列来实现</li>
</ul>
<p>Hawk3的过滤器还支持几种不同的行为，即过滤模式，分别是：</p>
<ul>
<li>按行过滤</li>
<li>成功后通过之后的所有行</li>
<li>失败后通过之后所有行</li>
</ul>
<h3 id="24">2.4.执行器</h3>
<p>执行器是负责将Hawk的结果传送到外部环境的工具。
你可以写入数据表，数据库，甚至执行某个特定的动作，或是生成文件等等。
在调试模式下，执行器都是不工作的。这是为了避免产生副作用。否则，每刷新一遍数据，就会向数据库中写入，这显然是不可接受的。
只有在运行模式下，才会使执行器生效。</p>
<h3 id="25">2.5.生成器</h3>
<p>顾名思义，生成器就是通过一定的参数，生成一个文档列表的组件。生成器通常位于任务开头，可从文本，文件，数据库读取数据。 或者从一个区间内生成纵向的数字和时间。</p>
<p>它与转换器有很多相似之处，但是明显不同：</p>
<ul>
<li>转换器必须有输入，而生成器不需要。生成器一般需要输出列，来保存其输出的数据。</li>
<li>生成器输出的数据可以与原始数据进行横向/纵向/交叉拼接，这远比转换器灵活</li>
<li>生成器的参数都支持方括号语法，但转换器只有部分支持</li>
</ul>
<p>当生成器生成数据后，如何与原始的数据组合呢？有四种模式：</p>
<ul>
<li>按行纵向合并</li>
<li>笛卡尔交叉</li>
<li>交错交叉</li>
<li>按列横向合并</li>
</ul>
<p><img alt="生成器的四种模式" src="https://images2018.cnblogs.com/blog/287060/201805/287060-20180506160537169-568274026.png" /></p>
<p>拖入的模块顺序是非常重要的，一个常见问题是顺序不对，导致生成的数据不符合预期。数据清洗可通过 从爬虫转换 来调用 网页采集器 ，也可以通过<code>子任务</code>来调用其他数据清洗，是组合各种模块和任务的工厂。</p>
<h2 id="3">3.超级拷贝</h2>
<p>Hawk3.5增强了对拷贝功能的支持，使得操作更加简便。</p>
<p>不论是数据表列表，任务,模块或工作线程列表，都可以使用windows键盘快捷键shift+鼠标来多选，或使用ctrl+a全选，选择后即可执行删除和暂停等操作。</p>
<p>对于最常用的模块列表，右键即可拷贝当前所选的模块。已拷贝的模块支持如下功能：</p>
<ul>
<li>可以直接粘贴到任何文本编辑器中，这在手动编辑xml工程文件时很有用。</li>
<li>拷贝到本任务或其他任务的任一模块的上侧或下侧</li>
</ul>
<p>//TODO:增加一个图</p>
<p>这带来了显著的好处，任务间能够更方便地共享配置和参数，方便重用。你亦可将配置拷贝到GitHub或其他社群中，方便他人定位问题。</p>
<h2 id="4">4.线程管理</h2>
<p>不论是调试还是执行模式，系统都会在任务管理视图中增加一个或多个线程。
你可以勾选，或取消勾选部分或全部线程，暂停或取消它们。当网站限制抓取时，可以暂停所有线程，等恢复后再次执行。</p>
<p>注意:</p>
<ol>
<li>当工作流有误时（比如该列所有数据都空，却在该列添加了 空对象过滤器，那么所有数据都会被过滤）可能不会产生任何数据输出。此时进度条并不会向前推进，产生卡死的假象。此时可强行将其删除</li>
<li>线程删除的流程是：先安全将其取消，如果线程无响应，则会直接将其杀死</li>
</ol>
<h3 id="41">4.1.单步调试</h3>
<p>Hawk模仿了播放器和调试器，在调试模式下有<code>步</code>的概念，例如所在位置是6/20， 则说明总共有20个模块，只生效前面6个模块。 可以通过左右单击，或直接回退到开头、末尾来进行调试。</p>
<p>左侧显示了当前所有的模块，顺序和它们的输入输出列，双击上面的模块可对其进行配置，右键可删除。单选列表上的任一模块t，系统就会只仿真前t步的效果。 本质上，单步调试只是提取了工作流的一部分进行操作。   你可以在单步调试中，拖入新的模块。模块会自动插入在工作流中间。</p>
<p><img alt="上下拖拽，右键配置每一步的参数" src="https://images2018.cnblogs.com/blog/287060/201805/287060-20180506155928987-1522342347.png" /></p>
<p>有时为了在单步调试过程中查看模块的属性，可勾选界面右下角的<code>调试详情</code>，此时可直接显示当前模块的属性。</p>
<p><img alt="模块数量" src="https://images2018.cnblogs.com/blog/287060/201805/287060-20180506160222760-1330008382.png" /></p>
<p>当模块有正常产出时， 模块的标志会变成蓝色，因此从上到下，第一个不是蓝色的模块，就有可能是有问题的模块。</p>
<h2 id="5">5.运行模式</h2>
<h3 id="51">5.1.调试模式</h3>
<p>在编辑任务的过程中，处于<strong>调试模式</strong>，它具备如下特点：</p>
<ul>
<li>所有执行器都不工作，避免副作用</li>
<li>点击下方中间的刷新按钮，或修改配置，展示的数据会自动刷新</li>
<li>只能运行在串行模式上</li>
<li>所见即所得，只显示一定数量的数据（通过采样量修改）</li>
<li>可以禁用或启用某些模块，观察效果</li>
<li>会加入web请求和读取文件的缓存， 来提升预览速度（可能会导致一些问题）</li>
<li>输入列和输出列会用不同的颜色进行表示</li>
</ul>
<p>在调试时，从爬虫转换模块可能会请求web数据，为了提升性能，该模块对请求做了缓存。保证数据只需获取一次，如果想强制刷新数据，将从爬虫转换模块禁用，再启用，原始缓存数据就会被擦除。</p>
<p>Hawk支持两种执行模式:</p>
<h3 id="52">5.2.串行模式</h3>
<p>只有点击<strong>执行</strong>时，才会切换到执行模式。执行时，可工作在串行模式/并行模式
在串行模式下， 所有任务串行执行，速度慢，但对网站压力小，不容易被封锁。为了进一步降低执行速度，可以设置延时时间，此时每次网络请求前，都会延时一定时间。
注意:</p>
<ol>
<li>当执行器包含类似"向文件中追加内容"的操作时，强烈建议使用串行模式，因为Hawk没有加入多线程锁，有可能会导致冲突。</li>
<li>建议完成爬虫设计后，先进行串行模式，初步观察是否正确，之后再设置并行模式大量抓取。</li>
</ol>
<h3 id="53">5.3.并行模式</h3>
<p>极大地加快了抓取速度，但很容易被封锁。 Hawk使用了线程池的机制，可以设置最大工作线程数，只有之前的工作线程完成工作，才会填入新的任务。否则过多的线程会迅速占用所有系统资源。</p>
<p>相比于Hawk2, Hawk3会自动分析可以并行的位置，因此多数情况下，直接运行就可以了。但是如果你想自定义并行化的行为，就需要阅读下面的内容。</p>
<h3 id="54">5.4.并行化的原理</h3>
<p>在调试模式下，所有获取都是串行的。而执行模式下，执行器才会执行。为了更好地理解并行化，强烈建议阅读下面的内容。</p>
<h4 id="_2">最简单的并行化</h4>
<p>我们以抓取某个网站的100个页面为例，第一个模块<code>生成区间数</code>,可以生成1-100的页面，自然地，就可以创建100个任务，分别抓取了。</p>
<p><img alt="image_1auq4sikn7nb1gug1citurl149pm.png-20.6kB" src="http://static.zybuluo.com/buptzym/7r3yufza2cshsualz9iz2qd7/image_1auq4sikn7nb1gug1citurl149pm.png" /></p>
<p>但是，但如果队首的生成器只生成了很少的元素，每个元素在后期，又会转换为大量的元素，那么这种方法就非常低下了。极端情况下队首生成器只生成一个元素，则并行化就毫无意义：</p>
<p><img alt="image_1auq59r2f42r12u41cue1q6c9cj1t.png-28kB" src="http://static.zybuluo.com/buptzym/sojkdkg2ta9r2xrx6z7ivrgm/image_1auq59r2f42r12u41cue1q6c9cj1t.png" /></p>
<h4 id="_3">改进的并行</h4>
<p>一种非常简单的思路，是将其切成两个任务，并行在任务中完成。</p>
<p><img alt="image_1auq4roi010n6lnomf41o56s919.png-63.9kB" src="http://static.zybuluo.com/buptzym/ulbme5gwk8ns3ykby6efeesx/image_1auq4roi010n6lnomf41o56s919.png" /></p>
<p>我们将其看成两个任务，第一个任务，负责产生出一堆种子任务出来，并加入到任务队列，之后再在这些种子的基础上，再分别调用第第二个任务。</p>
<p>如何切分任务？取决于你在任务中插入的<code>启动并行</code>的位置。这个位置就是切分为两个任务的“切割点”。</p>
<p>以大众点评为例， 北京有14个区县，有30种美食类型，如果直接在区县后插入并行，则只有14个子任务，任务数量太少：那么先通过任务1,获取420个元素，再以420个元素的基础上，插入并行，这样速度就快很多了。你也可以在14个区县之后插入并行化，那么就有14个子任务。</p>
<p>反过来，如果每个任务的工作量太少，比如只访问一次网站内容，则这样的种子创建并行就显得成本高昂，因此可以填写分组并行数量，比如10，那么Hawk就会以10个元素为一组，创建任务。</p>
<p><img alt="image_1auq5ldh81i2n6ajqhe1ns23k72a.png-25kB" src="http://static.zybuluo.com/buptzym/by68ones5fqurqicpswhbdex/image_1auq5ldh81i2n6ajqhe1ns23k72a.png" /></p>
<h4 id="hawk">Hawk自动分析并行点</h4>
<p>Hawk除了手工设置并行点，还能自动分析并行点，那么并行点是不是越靠后越好呢？不是的，这样分的太细，每个任务要处理的数据特别少：依赖于批量执行的模块会有性能损失: 例如写入数据库,批量插入100条数据速度很快，但按条插入就不快了。</p>
<p>但若尽量靠前，则任务分得特别粗，在断点续跑时，任务需要更多的时间达到相同的位置（这点不够直观，可以理解为层级越多，则进行查找所需的步数越少）</p>
<p>目前Hawk采用了尽量靠后的策略，未来可能会在这方面变得更加智能。</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../转换器/" class="btn btn-neutral float-right" title="8.转换器">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../网页采集器/" class="btn btn-neutral" title="6.网页采集器"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../网页采集器/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../转换器/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
