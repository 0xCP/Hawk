<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>13.子任务引擎 - Hawk doc</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "13.\u5b50\u4efb\u52a1\u5f15\u64ce";
    var mkdocs_page_input_path = "\u5b50\u4efb\u52a1\u5f15\u64ce.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Hawk doc</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">1.Hawk</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../快速教程/">2.快速教程</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Hawk工程/">3.Hawk工程</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../主要组件介绍/">4.主要组件介绍</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../数据表和数据库连接/">5.数据表和数据库连接</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../网页采集器/">6.网页采集器</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../数据清洗/">7.数据清洗</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../转换器/">8.转换器</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../常用/">9.常用</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../过滤器/">10.过滤器</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../执行器/">11.执行器</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../生成器/">12.生成器</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">13.子任务引擎</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#_1">子任务引擎</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#1">1.基本概念</a></li>
        
            <li><a class="toctree-l3" href="#2">2.参数设置</a></li>
        
            <li><a class="toctree-l3" href="#3">3.注意事项</a></li>
        
            <li><a class="toctree-l3" href="#4">4.示例</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../动态页面抓取专题/">14.动态页面抓取专题</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../增量,自动化定时抓取专题/">15.增量,自动化定时抓取专题</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../编译和扩展开发/">16.编译和扩展开发</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../常见问题/">17.常见问题</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../关于作者/">18.关于作者</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../设计Hawk背后的故事(2016)/">19.设计Hawk背后的故事(2016)</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../花一年时间,给爬虫Hawk再讲个故事(2018)/">20.花一年时间,给爬虫Hawk再讲个故事(2018)</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Hawk doc</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>13.子任务引擎</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="_1">子任务引擎</h1>
<p>（早期版本的Hawk称之为子流程，为了简化概念，使用<code>子任务</code>这一说法，下同）</p>
<h2 id="1">1.基本概念</h2>
<p>当流程设计的越来越复杂，越来越长时，就难以进行管理了。因此，采用模块化的设计才会更加合理。本节我们介绍子任务的原理和使用。</p>
<p>子任务是Hawk中高级但却非常重要的功能，可以实现例如多级跳转，采集详情页等等的功能，非常强大。</p>
<p>所谓<code>子任务</code>，就是能先构造出一个任务，然后被其他任务调用。被调用的任务就是子任务。我们应该能够了解子任务其实就是函数，可以定义输入列和输出列，把整个子任务看成一个模块，从而方便重用。</p>
<p>子任务的功能包含以下三类：</p>
<ul>
<li>子任务-生成，作为生成器，一般在主任务的开头位置，行为和生成器一致。</li>
<li>如生成全国城市列表的流</li>
<li>生成某个网站全部分类的流</li>
<li>子任务-转换: 可看成转换器，通常位于任务中间位置</li>
<li>通过输入url地址，就能转换出该页面中所有需要信息的流</li>
<li>子任务-执行: 作为执行器，一般位于末尾。</li>
<li>例如可以构造获取某个页面所有图片的执行流</li>
</ul>
<p>为什么不包括子任务-过滤？因为过滤操作通常比较简单，不需要子任务实现。</p>
<h2 id="2">2.参数设置</h2>
<p>子任务可以分为两部分：参数部分和执行部分。在本例中，子任务中的第一个<code>从文本生成</code>，只是参数，目的是为了子任务设计器能构成输出数据的完整流程。但要想被别的模块调用，则只应该有执行部分。而参数部分，需要主任务传递给子任务。这就是<code>调用范围</code>的意义，它能将主任务的指定参数传递到子任务上，成为子任务的一部分。</p>
<p>举例子，如果一个长度为20个模块的子任务，前两个模块为参数部分，后18个是执行部分，因此调用范围可以写2:18（从0开始）。 当然为了方便，你可以给冒号后第二个数比较大的值，如100。范围的第二个数也可以写成负数，如<code>2:-2</code>表示<code>从第二个模块到倒数第2个模块</code></p>
<p>那么，如果主任务传递的列名，和子任务需要的列名不同时，该怎么处理？ 这就需要属性映射机制。配置子任务的<code>属性映射</code>时，可以用<code>a:b c:d</code>表示a列映射到b列，以此类推。</p>
<p>若不需要映射，则直接填写<code>a c</code>表示要将a列和c列传递给子任务，主任务不会也不需要将所有的参数都传递给子任务。因此，需要在子任务的转换器上，显式地设置原列名，并用空格分割。</p>
<p>Hawk3中还提供了图形化配置的界面，大大简化了配置难度，在任何子任务调用的模块里，都可以点击<code>配置</code>进入配置页面：</p>
<p><img alt="子任务的配置界面" src="https://images2018.cnblogs.com/blog/287060/201805/287060-20180506160707394-384705130.png" /></p>
<h2 id="3">3.注意事项</h2>
<p>下面是一些注意事项：</p>
<ul>
<li>主任务不会将所有的参数都传递给子任务，因为这可能并没有必要。因此，需要在子任务的转换器上，显式地设置原列名，并用空格分割，这样才能传递过去。</li>
<li>子任务还可以调用其他的子任务，形成树状的调用结构。当加载一个任务时，该任务依赖的子任务也会自动加载。对子任务的修改，也会传递到主任务上。目前，任务之间还不能自调用，也不能形成调用环。虽然函数确实是可以递归调用的，但对一个以generator为核心的流系统，递归可能并不需要。但如果真的支持，那一定会相当强大。</li>
<li>其实，在子任务层面，转换和执行除了是否有副作用外，最大的区别在于对主任务的影响，<code>子任务-转换</code>会将所有的结果返回给主任务，但<code>子任务-执行</code>则只需要输入参数，之后就是无头僵尸，将数据写到其他位置后，并不会影响主任务，在主任务中也看不到任何效果。这一段有些难以理解，但确实非常重要.</li>
</ul>
<h2 id="4">4.示例</h2>
<p>在教学工程中，可以看到多个调用子任务的示例。</p>
<p>下面以一个非常简单的任务来阐述子任务的用法：</p>
<p>新建一个<code>数据清洗</code>，命名为主任务，生成1-20的区间数，列名为id.</p>
<p>接下来，我们希望能生成id2和id3两个列，数值分别为id的两倍和三倍，再把它们拼接起来。你可以直接拖入两个<code>python转换器</code>到id, 脚本为<code>int(value)*2</code> 和<code>int(value)*3</code>，最后再拖入一个<code>合并多列</code>,格式为<code>{0}_{1}</code>，再删掉刚才生成的三个列，这样就生成了下面的列:</p>
<pre><code>2_3
4_6
6_9
...
</code></pre>

<p>但是，如果不仅有id这一列，还有别的列需要做一样的处理，那就需要做重复的操作了。我们完全可以将其封装起来重复使用。</p>
<p>新建一个<code>数据清洗</code>，命名为<code>子任务</code>，新建<code>从文本生成</code>,列名为id, 内容只要一个<code>1</code>就可以了，之后按照刚才的步骤，生成<code>2_3</code>这样的列。</p>
<p>之后，在主任务上，对id列拖入<code>子任务-转换</code>，在弹出的面板上，<code>子任务-选择</code>中填入<code>子任务</code>，<code>调用范围</code>填入<code>1:100</code>, 刷新后，即可看到和之前相同的结果。</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../动态页面抓取专题/" class="btn btn-neutral float-right" title="14.动态页面抓取专题">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../生成器/" class="btn btn-neutral" title="12.生成器"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../生成器/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../动态页面抓取专题/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
